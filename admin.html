<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Â· ì‚¬ìš©ì/ìº í¼ìŠ¤ ê¶Œí•œ ì„¤ì •</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; margin: 0; background:#f6f7fb; }
    header { background:#111827; color:#fff; padding:16px 20px; display:flex; justify-content:space-between; align-items:center; }
    header .title { font-weight:700; }
    header .sub { opacity:.8; font-size:13px; }
    main { max-width:1100px; margin: 18px auto; padding: 0 16px 40px; }
    .row { display:flex; gap:14px; flex-wrap:wrap; }
    .card { background:#fff; border-radius:14px; box-shadow: 0 6px 18px rgba(0,0,0,.06); padding:14px; }
    .card h2 { margin:0 0 10px; font-size:16px; }
    .left { flex: 1 1 420px; min-width: 340px; }
    .right { flex: 1 1 520px; min-width: 360px; }
    .muted { color:#6b7280; font-size:13px; }
    .btn { border:0; border-radius:10px; padding:10px 12px; cursor:pointer; font-weight:600; }
    .btn.primary { background:#111827; color:#fff; }
    .btn.gray { background:#e5e7eb; color:#111827; }
    .btn.danger { background:#ef4444; color:#fff; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    table { width:100%; border-collapse:collapse; }
    th, td { text-align:left; padding:10px 8px; border-bottom:1px solid #eef0f4; font-size:14px; }
    th { font-size:12px; color:#6b7280; font-weight:700; text-transform:uppercase; letter-spacing:.03em; }
    tr:hover { background:#fafafa; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700; }
    .pill.admin { background:#fee2e2; color:#991b1b; }
    .pill.manager { background:#dbeafe; color:#1e40af; }
    .pill.staff { background:#dcfce7; color:#166534; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    label { display:block; font-size:12px; color:#6b7280; font-weight:700; margin:8px 0 6px; }
    input, select { width:100%; padding:10px 11px; border:1px solid #e5e7eb; border-radius:10px; font-size:14px; background:#fff; }
    .hint { font-size:12px; color:#6b7280; margin-top:6px; }
    .scopeWrap { max-height:520px; overflow:auto; border:1px solid #eef0f4; border-radius:12px; padding:10px; background:#fbfbfe; }
    .schoolBlock { border:1px solid #e5e7eb; border-radius:12px; padding:10px; background:#fff; margin-bottom:10px; }
    .schoolHead { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .schoolTitle { font-weight:800; }
    .campusList { margin-top:10px; padding-left:10px; display:grid; gap:6px; }
    .campusItem { display:flex; align-items:center; gap:10px; font-size:14px; }
    .topbar { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .status { margin-left:auto; font-size:13px; color:#6b7280; }
    .warn { background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; padding:10px 12px; border-radius:12px; font-size:13px; margin-top:10px; }
    .ok { background:#ecfdf5; border:1px solid #a7f3d0; color:#065f46; padding:10px 12px; border-radius:12px; font-size:13px; margin-top:10px; }
    code { background:#f3f4f6; padding:2px 6px; border-radius:8px; }
  </style>
</head>

<body>
<header>
  <div>
    <div class="title">Admin Â· ì‚¬ìš©ì/ìº í¼ìŠ¤ ê¶Œí•œ ì„¤ì •</div>
    <div class="sub">profiles / user_scopes ê¸°ë°˜ Â· Admin ì „ì‚¬ ë¬´ì œí•œ</div>
  </div>
  <div class="topbar">
    <button class="btn gray" id="btnSignIn">ë¡œê·¸ì¸</button>
    <button class="btn gray" id="btnSignOut" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</header>

<main>
  <div class="warn" id="banner">
    ğŸ”’ ì´ í˜ì´ì§€ëŠ” <b>admin</b>ë§Œ ì‚¬ìš©í•˜ì„¸ìš”. ë¨¼ì € ë¡œê·¸ì¸ í›„, Admin ê¶Œí•œì´ í™•ì¸ë˜ë©´ í™”ë©´ì´ í™œì„±í™”ë©ë‹ˆë‹¤.
  </div>

  <div class="row" style="margin-top:14px;">
    <!-- LEFT: USERS -->
    <section class="card left">
      <div style="display:flex; align-items:baseline; justify-content:space-between; gap:10px;">
        <h2>ì‚¬ìš©ì ëª©ë¡</h2>
        <div class="status" id="me"></div>
      </div>

      <div class="grid2" style="margin-bottom:10px;">
        <div>
          <label>ê²€ìƒ‰(ì´ë¦„)</label>
          <input id="qName" placeholder="ì˜ˆ: í™ê¸¸ë™" />
        </div>
        <div>
          <label>ì—­í•  í•„í„°</label>
          <select id="qRole">
            <option value="">ì „ì²´</option>
            <option value="admin">admin</option>
            <option value="manager">manager</option>
            <option value="staff">staff</option>
          </select>
        </div>
      </div>

      <button class="btn primary" id="btnLoadUsers" disabled>ì‚¬ìš©ì ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <div class="hint">â€» users í…Œì´ë¸”ì´ ì•„ë‹ˆë¼ <code>profiles</code>ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</div>

      <div style="margin-top:12px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>ì´ë¦„</th>
              <th>ì—­í• </th>
              <th>í™œì„±</th>
              <th>ë‹´ë‹¹ ìº í¼ìŠ¤</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="usersTbody">
            <tr><td colspan="5" class="muted">ë¡œê·¸ì¸ í›„ ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ ëˆ„ë¥´ì„¸ìš”.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="ok" id="hintAdmin" style="display:none;">
        âœ… Admin í™•ì¸ë¨. ì‚¬ìš©ì ì„ íƒ í›„ ì˜¤ë¥¸ìª½ì—ì„œ ë‹´ë‹¹ ìº í¼ìŠ¤ë¥¼ ì²´í¬í•˜ê³  <b>ì €ì¥</b>í•˜ì„¸ìš”.
      </div>
    </section>

    <!-- RIGHT: SCOPES -->
    <section class="card right">
      <h2>ë‹´ë‹¹ ìº í¼ìŠ¤ ì„¤ì •</h2>
      <div class="muted" id="selInfo">ì™¼ìª½ì—ì„œ ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>

      <div style="margin-top:10px;" class="grid2">
        <div>
          <label>ì„ íƒ ì‚¬ìš©ì</label>
          <input id="selUserName" disabled placeholder="ì‚¬ìš©ì ì„ íƒ í•„ìš”" />
        </div>
        <div>
          <label>ì—­í• (role)</label>
          <select id="selUserRole" disabled>
            <option value="admin">admin</option>
            <option value="manager">manager</option>
            <option value="staff">staff</option>
          </select>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>í™œì„± ì—¬ë¶€</label>
          <select id="selUserActive" disabled>
            <option value="true">í™œì„±</option>
            <option value="false">ë¹„í™œì„±</option>
          </select>
        </div>
        <div>
          <label>ë‹´ë‹¹ ìº í¼ìŠ¤ ê°œìˆ˜</label>
          <input id="scopeCount" disabled />
        </div>
      </div>

      <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
        <button class="btn gray" id="btnLoadScopes" disabled>ìº í¼ìŠ¤ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="btn primary" id="btnSaveScopes" disabled>ì €ì¥</button>
        <button class="btn danger" id="btnClearScopes" disabled>ì „ë¶€ í•´ì œ</button>
      </div>

      <div class="hint">
        - Adminì€ ì „ì‚¬ ë¬´ì œí•œì´ë¼ ìº í¼ìŠ¤ë¥¼ ì•ˆ ì¤˜ë„ ë©ë‹ˆë‹¤.<br/>
        - Manager/StaffëŠ” ìµœì†Œ 1ê°œ ìº í¼ìŠ¤ ì§€ì • ê¶Œì¥(0ê°œë©´ ì•„ë¬´ ê²ƒë„ ëª» ë´„).
      </div>

      <div style="margin-top:12px;" class="scopeWrap" id="scopeWrap">
        <div class="muted">ìº í¼ìŠ¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>

      <div id="msg"></div>
    </section>
  </div>
</main>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  // ğŸ”´ ë³¸ì¸ ê°’ìœ¼ë¡œ ë³€ê²½
  const SUPABASE_URL = "https://YOUR_PROJECT.supabase.co";
  const SUPABASE_ANON_KEY = "YOUR_ANON_KEY";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (id) => document.getElementById(id);

  let me = null;           // { user_id, name, role }
  let selectedUser = null; // { user_id, name, role, is_active }
  let campusesBySchool = []; // [{school_id, school_name, campuses:[{campus_id,campus_name}]}]
  let selectedCampusIds = new Set();

  function pill(role) {
    return `<span class="pill ${role}">${role}</span>`;
  }

  function setMsg(type, text) {
    const box = $("msg");
    if (!text) { box.innerHTML = ""; return; }
    const cls = type === "ok" ? "ok" : "warn";
    box.innerHTML = `<div class="${cls}">${text}</div>`;
  }

  async function ensureAdmin() {
    const { data: sess } = await supabase.auth.getSession();
    if (!sess.session) {
      $("me").textContent = "ë¡œê·¸ì¸ í•„ìš”";
      $("btnSignIn").style.display = "";
      $("btnSignOut").style.display = "none";
      disableAll();
      return false;
    }

    // ë‚´ profiles í™•ì¸
    const { data: prof, error } = await supabase
      .from("profiles")
      .select("user_id,name,role,is_active")
      .eq("user_id", sess.session.user.id)
      .maybeSingle();

    if (error || !prof) {
      $("me").textContent = "profiles ì—†ìŒ/ê¶Œí•œ ì—†ìŒ";
      disableAll();
      return false;
    }

    me = prof;
    $("me").innerHTML = `ë‚´ ê³„ì •: <b>${me.name}</b> Â· ${pill(me.role)}`;
    $("btnSignIn").style.display = "none";
    $("btnSignOut").style.display = "";

    const isAdmin = me.role === "admin";
    if (!isAdmin) {
      $("banner").innerHTML = `â›” ì´ ê³„ì •ì€ adminì´ ì•„ë‹™ë‹ˆë‹¤. í˜„ì¬ role: <b>${me.role}</b>`;
      disableAll();
      return false;
    }

    $("banner").innerHTML = `âœ… Admin ë¡œê·¸ì¸ í™•ì¸ë¨. ì™¼ìª½ì—ì„œ ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ê³ , ì˜¤ë¥¸ìª½ì—ì„œ ë‹´ë‹¹ ìº í¼ìŠ¤ë¥¼ ì„¤ì •í•˜ì„¸ìš”.`;
    $("hintAdmin").style.display = "";
    $("btnLoadUsers").disabled = false;
    return true;
  }

  function disableAll() {
    $("btnLoadUsers").disabled = true;
    $("btnLoadScopes").disabled = true;
    $("btnSaveScopes").disabled = true;
    $("btnClearScopes").disabled = true;
    $("selUserRole").disabled = true;
    $("selUserActive").disabled = true;
  }

  async function signIn() {
    // ê°€ì¥ ë‹¨ìˆœ: ì´ë©”ì¼/ë¹„ë²ˆ ë¡œê·¸ì¸ ëª¨ë‹¬ ì—†ì´ promptë¡œ ì²˜ë¦¬(ì›í•˜ë©´ ì˜ˆìœ UIë¡œ ê°œì„  ê°€ëŠ¥)
    const email = prompt("Admin ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”:");
    if (!email) return;
    const password = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
    if (!password) return;

    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message);
    await ensureAdmin();
  }

  async function signOut() {
    await supabase.auth.signOut();
    selectedUser = null;
    campusesBySchool = [];
    selectedCampusIds = new Set();
    renderUsers([]);
    renderScopeTree([]);
    $("selUserName").value = "";
    $("selUserRole").value = "staff";
    $("selUserActive").value = "true";
    $("scopeCount").value = "";
    $("selInfo").textContent = "ì™¼ìª½ì—ì„œ ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ì„¸ìš”.";
    setMsg("", "");
    await ensureAdmin();
  }

  async function loadUsers() {
    setMsg("", "");
    const qName = $("qName").value.trim();
    const qRole = $("qRole").value;

    let query = supabase.from("profiles").select("user_id,name,role,is_active").order("name", { ascending: true });

    if (qRole) query = query.eq("role", qRole);
    if (qName) query = query.ilike("name", `%${qName}%`);

    const { data, error } = await query;
    if (error) { setMsg("warn", "ì‚¬ìš©ì ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + error.message); return; }

    // ë‹´ë‹¹ ìº í¼ìŠ¤ ìˆ˜ ê³„ì‚°: user_scopes count
    // (ê°„ë‹¨í•˜ê²Œ 2ë²ˆ í˜¸ì¶œ; ê·œëª¨ ì»¤ì§€ë©´ RPC/ë·°ë¡œ ìµœì í™”)
    const ids = data.map(u => u.user_id);
    let counts = new Map();
    if (ids.length) {
      const { data: scopes, error: e2 } = await supabase
        .from("user_scopes")
        .select("user_id,campus_id")
        .in("user_id", ids);
      if (!e2 && scopes) {
        for (const s of scopes) counts.set(s.user_id, (counts.get(s.user_id) || 0) + 1);
      }
    }

    renderUsers(data.map(u => ({...u, scope_count: counts.get(u.user_id) || 0 })));
  }

  function renderUsers(users) {
    const tb = $("usersTbody");
    if (!users.length) {
      tb.innerHTML = `<tr><td colspan="5" class="muted">í‘œì‹œí•  ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
      return;
    }
    tb.innerHTML = users.map(u => `
      <tr>
        <td><b>${escapeHtml(u.name)}</b></td>
        <td>${pill(u.role)}</td>
        <td>${u.is_active ? "í™œì„±" : "<span class='muted'>ë¹„í™œì„±</span>"}</td>
        <td>${u.scope_count ?? 0}</td>
        <td><button class="btn gray" data-pick="${u.user_id}">ì„ íƒ</button></td>
      </tr>
    `).join("");

    tb.querySelectorAll("button[data-pick]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-pick");
        const u = users.find(x => x.user_id === id);
        await pickUser(u);
      });
    });
  }

  async function pickUser(u) {
    selectedUser = u;
    $("selUserName").value = u.name;
    $("selUserRole").value = u.role;
    $("selUserActive").value = String(!!u.is_active);
    $("selUserRole").disabled = false;
    $("selUserActive").disabled = false;

    $("btnLoadScopes").disabled = false;
    $("btnSaveScopes").disabled = true;
    $("btnClearScopes").disabled = true;

    $("selInfo").innerHTML = `ì„ íƒë¨: <b>${escapeHtml(u.name)}</b> (${u.user_id})`;
    setMsg("", "");

    // ìë™ìœ¼ë¡œ ìº í¼ìŠ¤ íŠ¸ë¦¬ ë¡œë“œ + í˜„ì¬ ìŠ¤ì½”í”„ í‘œì‹œ
    await loadCampusTreeIfNeeded();
    await loadSelectedUserScopes();
    updateScopeCount();
    $("btnSaveScopes").disabled = false;
    $("btnClearScopes").disabled = false;
  }

  async function loadCampusTreeIfNeeded() {
    if (campusesBySchool.length) return;

    // schools
    const { data: schools, error: e1 } = await supabase
      .from("schools")
      .select("school_id,school_name,is_active")
      .order("school_name", { ascending: true });

    if (e1) { setMsg("warn", "schools ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + e1.message); return; }

    // campuses
    const { data: campuses, error: e2 } = await supabase
      .from("campuses")
      .select("campus_id,school_id,campus_name,is_active")
      .order("campus_name", { ascending: true });

    if (e2) { setMsg("warn", "campuses ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + e2.message); return; }

    const map = new Map();
    for (const s of schools) map.set(s.school_id, { ...s, campuses: [] });
    for (const c of campuses) {
      const entry = map.get(c.school_id);
      if (entry) entry.campuses.push(c);
    }
    campusesBySchool = Array.from(map.values());

    renderScopeTree(campusesBySchool);
  }

  function renderScopeTree(groups) {
    const wrap = $("scopeWrap");
    if (!groups.length) {
      wrap.innerHTML = `<div class="muted">ìº í¼ìŠ¤ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      return;
    }

    wrap.innerHTML = groups.map(s => {
      const sid = s.school_id;
      const schoolChecked = s.campuses.length && s.campuses.every(c => selectedCampusIds.has(c.campus_id));
      const schoolIndet = s.campuses.some(c => selectedCampusIds.has(c.campus_id)) && !schoolChecked;

      return `
        <div class="schoolBlock" data-school="${sid}">
          <div class="schoolHead">
            <div class="schoolTitle">${escapeHtml(s.school_name)} ${s.is_active ? "" : "<span class='muted'>(ë¹„í™œì„±)</span>"}</div>
            <label style="margin:0; display:flex; align-items:center; gap:8px; font-weight:700; color:#111827;">
              <input type="checkbox" class="chkSchool" data-sid="${sid}" ${schoolChecked ? "checked": ""} />
              í•™êµ ì „ì²´ ì„ íƒ
            </label>
          </div>

          <div class="campusList">
            ${s.campuses.map(c => `
              <div class="campusItem">
                <input type="checkbox" class="chkCampus" data-cid="${c.campus_id}" data-sid="${sid}" ${selectedCampusIds.has(c.campus_id) ? "checked": ""}/>
                <div>${escapeHtml(c.campus_name)} ${c.is_active ? "" : "<span class='muted'>(ë¹„í™œì„±)</span>"}</div>
              </div>
            `).join("")}
          </div>
        </div>
      `;
    }).join("");

    // set indeterminate after render
    wrap.querySelectorAll(".chkSchool").forEach(chk => {
      const sid = chk.getAttribute("data-sid");
      const school = groups.find(x => x.school_id === sid);
      const checked = school.campuses.length && school.campuses.every(c => selectedCampusIds.has(c.campus_id));
      const partial = school.campuses.some(c => selectedCampusIds.has(c.campus_id)) && !checked;
      chk.indeterminate = partial;
    });

    wrap.querySelectorAll(".chkCampus").forEach(chk => {
      chk.addEventListener("change", () => {
        const cid = chk.getAttribute("data-cid");
        if (chk.checked) selectedCampusIds.add(cid);
        else selectedCampusIds.delete(cid);
        renderScopeTree(campusesBySchool);
        updateScopeCount();
      });
    });

    wrap.querySelectorAll(".chkSchool").forEach(chk => {
      chk.addEventListener("change", () => {
        const sid = chk.getAttribute("data-sid");
        const school = groups.find(x => x.school_id === sid);
        for (const c of school.campuses) {
          if (chk.checked) selectedCampusIds.add(c.campus_id);
          else selectedCampusIds.delete(c.campus_id);
        }
        renderScopeTree(campusesBySchool);
        updateScopeCount();
      });
    });
  }

  async function loadSelectedUserScopes() {
    if (!selectedUser) return;
    selectedCampusIds = new Set();

    const { data, error } = await supabase
      .from("user_scopes")
      .select("campus_id")
      .eq("user_id", selectedUser.user_id);

    if (error) { setMsg("warn", "í˜„ì¬ ìŠ¤ì½”í”„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + error.message); return; }
    for (const r of (data || [])) selectedCampusIds.add(r.campus_id);

    renderScopeTree(campusesBySchool);
    updateScopeCount();
  }

  function updateScopeCount() {
    $("scopeCount").value = String(selectedCampusIds.size || 0);
  }

  async function saveUserMeta() {
    if (!selectedUser) return;

    const role = $("selUserRole").value;
    const is_active = $("selUserActive").value === "true";

    const { error } = await supabase
      .from("profiles")
      .update({ role, is_active })
      .eq("user_id", selectedUser.user_id);

    if (error) { setMsg("warn", "í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: " + error.message); return false; }

    // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
    selectedUser.role = role;
    selectedUser.is_active = is_active;
    return true;
  }

  async function saveScopes() {
    if (!selectedUser) return;
    setMsg("", "");

    // 1) í”„ë¡œí•„(role/í™œì„±) ì €ì¥
    const okMeta = await saveUserMeta();
    if (!okMeta) return;

    // Adminì€ ì „ì‚¬ ë¬´ì œí•œì´ì§€ë§Œ, ê·¸ë˜ë„ ì €ì¥ì€ ê°€ëŠ¥í•˜ê²Œ ë‘ (ì›í•˜ë©´ ë§‰ì•„ë„ ë¨)
    // ì—¬ê¸°ì„  ë‹¨ìˆœí•˜ê²Œ: ì„ íƒëŒ€ë¡œ user_scopesë¥¼ ì €ì¥
    const uid = selectedUser.user_id;

    // 2) ê¸°ì¡´ ìŠ¤ì½”í”„ ì‚­ì œ
    const { error: eDel } = await supabase
      .from("user_scopes")
      .delete()
      .eq("user_id", uid);

    if (eDel) { setMsg("warn", "ê¸°ì¡´ ìŠ¤ì½”í”„ ì‚­ì œ ì‹¤íŒ¨: " + eDel.message); return; }

    // 3) ìƒˆ ìŠ¤ì½”í”„ ì‚½ì…
    const rows = Array.from(selectedCampusIds).map(campus_id => ({
      user_id: uid,
      campus_id,
      assigned_by: me.user_id
    }));

    if (rows.length) {
      const { error: eIns } = await supabase
        .from("user_scopes")
        .insert(rows);

      if (eIns) { setMsg("warn", "ìŠ¤ì½”í”„ ì €ì¥ ì‹¤íŒ¨: " + eIns.message); return; }
    }

    setMsg("ok", `âœ… ì €ì¥ ì™„ë£Œ: ${escapeHtml(selectedUser.name)} (${selectedCampusIds.size}ê°œ ìº í¼ìŠ¤)`);
    await loadUsers(); // ëª©ë¡ì˜ ë‹´ë‹¹ ìº í¼ìŠ¤ ìˆ˜ ê°±ì‹ 
  }

  function clearScopes() {
    selectedCampusIds = new Set();
    renderScopeTree(campusesBySchool);
    updateScopeCount();
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // EVENTS
  $("btnSignIn").addEventListener("click", signIn);
  $("btnSignOut").addEventListener("click", signOut);
  $("btnLoadUsers").addEventListener("click", loadUsers);
  $("btnLoadScopes").addEventListener("click", async () => {
    await loadCampusTreeIfNeeded();
    await loadSelectedUserScopes();
    $("btnSaveScopes").disabled = false;
    $("btnClearScopes").disabled = false;
  });
  $("btnSaveScopes").addEventListener("click", saveScopes);
  $("btnClearScopes").addEventListener("click", () => { clearScopes(); setMsg("", ""); });

  // Initial
  await ensureAdmin();
  supabase.auth.onAuthStateChange(async () => {
    await ensureAdmin();
  });
</script>
</body>
</html>
